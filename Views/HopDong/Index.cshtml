@model IEnumerable<do_an_tot_nghiep.ViewModels.HopDongListItemViewModel>
@{
    ViewData["Title"] = "Qu·∫£n l√Ω H·ª£p ƒê·ªìng";
    var total = Model?.Count() ?? 0;
    var active = Model?.Count(x => x.TrangThai == "Active" || x.TrangThai == "DangHieuLuc") ?? 0;
    var terminated = Model?.Count(x => x.TrangThai == "Terminated" || x.TrangThai == "DaThanhLy") ?? 0;
    var cancelled = Model?.Count(x => x.TrangThai == "Cancelled" || x.TrangThai == "Huy") ?? 0;
}

<div class="container-fluid px-0 py-2">

    @* Header *@
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-4 gap-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Index" class="text-muted text-decoration-none"><i class="fas fa-home me-1"></i>Trang ch·ªß</a></li>
                    <li class="breadcrumb-item active fw-medium">H·ª£p ƒë·ªìng</li>
                </ol>
            </nav>
            <h1 class="fw-bold mb-1" style="font-size:1.75rem; letter-spacing: -0.5px;">Qu·∫£n l√Ω h·ª£p ƒë·ªìng thu√™</h1>
            <p class="text-secondary mb-0">Theo d√µi to√†n b·ªô h·ª£p ƒë·ªìng trong h·ªá th·ªëng</p>
        </div>
        <a asp-action="Create" class="btn btn-gradient-primary btn-custom shadow-sm rounded-pill px-4">
            <i class="fas fa-pen-nib me-2"></i> T·∫°o h·ª£p ƒë·ªìng m·ªõi
        </a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible border-0 shadow-sm rounded-3 mb-4 fade show d-flex align-items-center">
            <i class="fas fa-check-circle fs-5 me-3"></i>
            <div>@TempData["Success"]</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible border-0 shadow-sm rounded-3 mb-4 fade show d-flex align-items-center">
            <i class="fas fa-exclamation-triangle fs-5 me-3"></i>
            <div>@TempData["Error"]</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @* Stat Cards *@
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 stat-card animate-fade-up h-100 p-3" style="cursor:pointer" onclick="filterStatus('')">
                <div class="card-body p-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted fw-semibold small mb-1">T·ªîNG H·ª¢P ƒê·ªíNG</div>
                            <h3 class="fw-bold text-dark mb-0">@total</h3>
                        </div>
                        <div class="stat-icon-wrapper bg-light rounded-circle p-3 text-secondary d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-file-signature fs-5"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 stat-card animate-fade-up h-100 p-3" style="cursor:pointer;animation-delay:.1s" onclick="filterStatus('active')">
                <div class="card-body p-1">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="text-muted fw-semibold small mb-1">ƒêANG HI·ªÜU L·ª∞C</div>
                            <h3 class="fw-bold text-success mb-0">@active</h3>
                        </div>
                        <div class="stat-icon-wrapper bg-success bg-opacity-10 text-success rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-check-circle fs-5"></i>
                        </div>
                    </div>
                    <small class="text-success fw-bold d-block mt-2" style="font-size:0.75rem;">(L·ªçc)</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 stat-card animate-fade-up h-100 p-3" style="cursor:pointer;animation-delay:.2s" onclick="filterStatus('terminated')">
                <div class="card-body p-1">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="text-muted fw-semibold small mb-1">ƒê√É THANH L√ù</div>
                            <h3 class="fw-bold text-warning mb-0">@terminated</h3>
                        </div>
                        <div class="stat-icon-wrapper bg-warning bg-opacity-10 text-warning rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-file-contract fs-5"></i>
                        </div>
                    </div>
                    <small class="text-warning fw-bold d-block mt-2" style="font-size:0.75rem;">(L·ªçc)</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 stat-card animate-fade-up h-100 p-3" style="cursor:pointer;animation-delay:.3s" onclick="filterStatus('cancelled')">
                <div class="card-body p-1">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="text-muted fw-semibold small mb-1">ƒê√É H·ª¶Y</div>
                            <h3 class="fw-bold text-danger mb-0">@cancelled</h3>
                        </div>
                        <div class="stat-icon-wrapper bg-danger bg-opacity-10 text-danger rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-ban fs-5"></i>
                        </div>
                    </div>
                    <small class="text-danger fw-bold d-block mt-2" style="font-size:0.75rem;">(L·ªçc)</small>
                </div>
            </div>
        </div>
    </div>

    @* Filter Bar *@
    <div class="card border-0 shadow-sm rounded-4 mb-4 p-4 animate-fade-up" style="animation-delay:.1s">
        <div class="row g-3 align-items-end">
            <div class="col-xl-4 col-md-6">
                <label class="fw-semibold small text-secondary mb-2 d-block"><i class="fas fa-search me-1"></i>T√¨m ki·∫øm h·ª£p ƒë·ªìng</label>
                <div class="input-group">
                    <span class="input-group-text bg-white text-muted border-end-0"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control border-start-0 shadow-none ps-0" id="searchInput" placeholder="M√£ Hƒê, t√™n ph√≤ng, s·ªë ti·ªÅn c·ªçc..." oninput="applyFilters()">
                </div>
            </div>
            <div class="col-xl-2 col-md-4">
                <label class="fw-semibold small text-secondary mb-2 d-block"><i class="fas fa-circle-notch me-1"></i>Tr·∫°ng th√°i</label>
                <select class="form-select shadow-none" id="filterStatus" onchange="applyFilters()">
                    <option value="">-- T·∫•t c·∫£ --</option>
                    <option value="active">üü¢ ƒêang hi·ªáu l·ª±c</option>
                    <option value="terminated">üü° ƒê√£ thanh l√Ω</option>
                    <option value="cancelled">üî¥ ƒê√£ h·ªßy</option>
                </select>
            </div>
            <div class="col-xl-2 col-md-4">
                <label class="fw-semibold small text-secondary mb-2 d-block"><i class="fas fa-calendar me-1"></i>T·ª´ ng√†y</label>
                <input type="date" class="form-control shadow-none" id="filterDateFrom" onchange="applyFilters()">
            </div>
            <div class="col-xl-2 col-md-4">
                <label class="fw-semibold small text-secondary mb-2 d-block"><i class="fas fa-calendar-check me-1"></i>ƒê·∫øn ng√†y</label>
                <input type="date" class="form-control shadow-none" id="filterDateTo" onchange="applyFilters()">
            </div>
            <div class="col-xl-1 col-md-3">
                <label class="fw-semibold small text-secondary mb-2 d-block d-none d-md-block">&nbsp;</label>
                <button class="btn btn-light border w-100 shadow-sm" onclick="resetFilters()" title="X√≥a b·ªô l·ªçc">
                    <i class="fas fa-sync-alt text-muted"></i>
                </button>
            </div>
        </div>
        <div id="filterTags" class="mt-3 d-flex flex-wrap gap-2"></div>
    </div>

    @* Table *@
    <div class="card border-0 shadow-sm rounded-4 animate-fade-up overflow-hidden" style="animation-delay:.2s">
        <div class="card-header bg-white border-bottom p-4 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-3">
                    <i class="fas fa-file-signature"></i>
                </div>
                <h5 class="fw-bold mb-0 ms-1">Danh s√°ch h·ª£p ƒë·ªìng</h5>
                <span class="badge bg-light text-dark border ms-2 rounded-pill"><span id="visibleCount">@total</span> / @total</span>
            </div>
            <button class="btn btn-light border shadow-sm btn-sm px-3 rounded-pill" onclick="location.reload()"><i class="fas fa-redo-alt text-secondary"></i></button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="dataTable">
                <thead class="table-light text-secondary text-uppercase small fw-bold" style="letter-spacing: 0.5px;">
                    <tr>
                        <th style="cursor:pointer" onclick="sortTable(0)" class="py-3">M√£ Hƒê <i class="fas fa-sort ms-1 text-muted opacity-50"></i></th>
                        <th class="py-3">Ph√≤ng</th>
                        <th class="py-3">Ng√†y b·∫Øt ƒë·∫ßu</th>
                        <th class="py-3">Ng√†y k·∫øt th√∫c</th>
                        <th class="text-end py-3">Ti·ªÅn c·ªçc</th>
                        <th class="text-end py-3">Gi√° thu√™</th>
                        <th class="text-center py-3">Tr·∫°ng th√°i</th>
                        <th class="text-center py-3" style="width:160px;">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody class="border-top-0">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            string sCls = (item.TrangThai == "Active" || item.TrangThai == "DangHieuLuc") ? "active"
                            : (item.TrangThai == "Terminated" || item.TrangThai == "DaThanhLy") ? "terminated" : "cancelled";
                            string badge = sCls == "active" ? "bg-success text-success" : sCls == "terminated" ? "bg-warning text-warning" : "bg-danger text-danger";
                            string label = sCls == "active" ? "ƒêang hi·ªáu l·ª±c" : sCls == "terminated" ? "ƒê√£ thanh l√Ω" : "ƒê√£ h·ªßy";
                            string dateStart = item.NgayBatDau.ToString("yyyy-MM-dd");
                            <tr class="bg-white" data-status="@sCls" data-date="@dateStart">
                                <td>
                                    <div class="fw-bold text-dark"><i class="fas fa-file-contract text-muted opacity-50 me-2"></i>@item.ContractCode</div>
                                </td>
                                <td><span class="fw-bold text-primary">@item.TenPhong</span></td>
                                <td><span class="badge bg-light border text-secondary px-2 py-1">@item.NgayBatDau.ToString("dd/MM/yyyy")</span></td>
                                <td>
                                    @if (item.NgayKetThuc.HasValue)
                                    {
                                        bool soonExpire = item.NgayKetThuc.Value <= DateTime.Now.AddDays(30) && sCls == "active";
                                        <span class="badge @(soonExpire ? "bg-warning bg-opacity-10 border border-warning border-opacity-25 text-warning" : "bg-light border text-secondary") px-2 py-1">
                                            @item.NgayKetThuc.Value.ToString("dd/MM/yyyy")
                                            @if (soonExpire)
                                            {
                                                <i class="fas fa-exclamation-triangle ms-1" title="S·∫Øp h·∫øt h·∫°n"></i>
                                            }
                                        </span>
                                    }
                                    else
                                    {

                                        <span class="text-muted small px-2 py-1 bg-light rounded border">V√¥ th·ªùi h·∫°n</span>
                                    }
                                </td>
                                <td class="text-end fw-bold text-dark">@item.TienCoc.ToString("N0") <small class="text-secondary fw-normal">ƒë</small></td>
                                <td class="text-end fw-bold text-primary">@item.GiaThue.ToString("N0") <small class="text-secondary fw-normal">ƒë</small></td>
                                <td class="text-center">
                                    <span class="badge @badge bg-opacity-10 border border-opacity-25 rounded-pill px-3 py-2">
                                        <i class="fas fa-circle me-1" style="font-size: 8px; vertical-align: middle;"></i> @label
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2 flex-wrap">
                                        <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-light border text-primary rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 5px;" title="Chi ti·∫øt"><i class="fas fa-eye"></i></a>
                                        @if (sCls == "active")
                                        {
                                            <a asp-action="Extend" asp-route-id="@item.Id" class="btn btn-sm btn-light border text-success rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 5px;" title="Gia h·∫°n"><i class="fas fa-calendar-plus"></i></a>
                                            <a asp-action="Terminate" asp-route-id="@item.Id" class="btn btn-sm btn-light border text-warning rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 5px;" title="Thanh l√Ω"><i class="fas fa-handshake"></i></a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                    <i class="fas fa-file-signature fa-2x text-secondary opacity-50"></i>
                                </div>
                                <h6 class="text-dark fw-bold">Ch∆∞a c√≥ h·ª£p ƒë·ªìng n√†o</h6>
                                <p class="text-muted small mb-4">Hi·ªán t·∫°i ch∆∞a c√≥ d·ªØ li·ªáu h·ª£p ƒë·ªìng n√†o ƒë∆∞·ª£c t·∫°o trong h·ªá th·ªëng.</p>
                                <a asp-action="Create" class="btn btn-primary shadow-sm rounded-pill px-4 mt-2"><i class="fas fa-plus me-2"></i> T·∫°o h·ª£p ƒë·ªìng</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div id="noResultsMsg" class="text-center py-5 d-none bg-light">
            <i class="fas fa-search fa-2x text-muted opacity-50 d-block mb-3"></i>
            <h6 class="text-dark fw-bold">Kh√¥ng t√¨m th·∫•y h·ª£p ƒë·ªìng ph√π h·ª£p</h6>
            <p class="text-muted small">H√£y th·ª≠ thay ƒë·ªïi ƒëi·ªÅu ki·ªán l·ªçc ho·∫∑c t·ª´ kh√≥a t√¨m ki·∫øm</p>
            <button class="btn btn-outline-secondary btn-sm shadow-sm rounded-pill px-4 mt-2" onclick="resetFilters()"><i class="fas fa-times me-1"></i> X√≥a t·∫•t c·∫£ b·ªô l·ªçc</button>
        </div>

        <div class="px-4 py-4 border-top bg-light d-flex flex-wrap justify-content-between align-items-center">
            <span class="text-secondary small">Hi·ªÉn th·ªã <strong class="text-dark" id="footerCount">@total</strong> / @total h·ª£p ƒë·ªìng</span>
            <div class="text-secondary small d-flex gap-3 mt-2 mt-md-0">
                <span><span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-2 me-1">@active</span> ƒêang hi·ªáu l·ª±c</span>
                <span><span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 rounded-pill px-2 me-1">@terminated</span> Thanh l√Ω</span>
                <span><span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill px-2 me-1">@cancelled</span> H·ªßy</span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const allRows = Array.from(document.querySelectorAll('#dataTable tbody tr[data-status]'));
        let sortDir = {};

        function filterStatus(status) {
            document.getElementById('filterStatus').value = status;
            applyFilters();
            document.getElementById('filterStatus').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function applyFilters() {
            const q       = document.getElementById('searchInput').value.toLowerCase().trim();
            const status  = document.getElementById('filterStatus').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo   = document.getElementById('filterDateTo').value;

            let visible = 0;
            allRows.forEach(row => {
                const matchQ  = !q || row.textContent.toLowerCase().includes(q);
                const matchSt = !status || row.dataset.status === status;
                const d       = row.dataset.date;
                const matchF  = !dateFrom || d >= dateFrom;
                const matchT  = !dateTo   || d <= dateTo;
                const show    = matchQ && matchSt && matchF && matchT;
                row.style.display = show ? '' : 'none';
                if (show) visible++;
            });

            ['visibleCount','footerCount'].forEach(id => {
                if(document.getElementById(id)) document.getElementById(id).textContent = visible;
            });
            document.getElementById('noResultsMsg').classList.toggle('d-none', visible > 0 || allRows.length === 0);
            renderTags(q, status, dateFrom, dateTo);
        }

        function renderTags(q, status, from, to) {
            const c = document.getElementById('filterTags');
            if (!c) return;
            c.innerHTML = '';
            const tag = (label, clear) => c.innerHTML += `<span class="badge bg-light text-secondary border px-3 py-2 rounded-pill shadow-sm d-inline-flex align-items-center" style="font-size:.8rem; font-weight: 500;">${label} <span class="ms-2 text-muted hover-danger" style="cursor:pointer;" onclick="${clear}"><i class="fas fa-times-circle"></i></span></span>`;
            if (q) tag(`üîç T·ª´ kh√≥a: "${q}"`, `document.getElementById('searchInput').value='';applyFilters()`);

            const sl = {active:'üü¢ ƒêang hi·ªáu l·ª±c', terminated:'üü° ƒê√£ thanh l√Ω', cancelled:'üî¥ ƒê√£ h·ªßy'};
            if (status) tag(`${sl[status]}`, `document.getElementById('filterStatus').value='';applyFilters()`);

            if (from) tag(`üìÖ T·ª´: ${from.split('-').reverse().join('/')}`, `document.getElementById('filterDateFrom').value='';applyFilters()`);
            if (to)   tag(`üìÖ ƒê·∫øn: ${to.split('-').reverse().join('/')}`,  `document.getElementById('filterDateTo').value='';applyFilters()`);
        }

        function resetFilters() {
            ['searchInput','filterStatus','filterDateFrom','filterDateTo'].forEach(id => {
                if(document.getElementById(id)) document.getElementById(id).value = '';
            });
            applyFilters();
        }

        function sortTable(col) {
            const tbody = document.querySelector('#dataTable tbody');
            const rows  = Array.from(tbody.querySelectorAll('tr[data-status]'));
            const asc   = !sortDir[col];
            sortDir = {}; sortDir[col] = asc;
            rows.sort((a,b) => {
                const av = a.cells[col]?.textContent.trim() || '';
                const bv = b.cells[col]?.textContent.trim() || '';
                return asc ? av.localeCompare(bv,'vi') : bv.localeCompare(av,'vi');
            });
            rows.forEach(r => tbody.appendChild(r));
        }
    </script>
    <style>
        /* Add a small hover effect for rows */
        .table-hover tbody tr:hover {
            background-color: #f8f9fa !important;
            transition: background-color 0.2s ease;
        }
        /* Small hover effect on cancel/close buttons inside pills */
        .hover-danger:hover {
            color: #dc3545 !important;
        }
    </style>
}