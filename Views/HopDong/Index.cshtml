@model IEnumerable<do_an_tot_nghiep.ViewModels.HopDongListItemViewModel>
@{
    ViewData["Title"] = "Qu·∫£n l√Ω H·ª£p ƒê·ªìng";
    var total      = Model?.Count() ?? 0;
    var active     = Model?.Count(x => x.TrangThai == "Active" || x.TrangThai == "DangHieuLuc") ?? 0;
    var terminated = Model?.Count(x => x.TrangThai == "Terminated" || x.TrangThai == "DaThanhLy") ?? 0;
    var cancelled  = Model?.Count(x => x.TrangThai == "Cancelled" || x.TrangThai == "Huy") ?? 0;
}

<div class="container-fluid px-0">

    {{-- Header --}}
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Index" class="text-muted text-decoration-none"><i class="fas fa-home me-1"></i>Trang ch·ªß</a></li>
                    <li class="breadcrumb-item active">H·ª£p ƒë·ªìng</li>
                </ol>
            </nav>
            <h1 class="fw-bold mb-0" style="font-size:1.75rem;">Qu·∫£n l√Ω h·ª£p ƒë·ªìng thu√™</h1>
            <p class="text-muted mb-0 mt-1">Theo d√µi to√†n b·ªô h·ª£p ƒë·ªìng trong h·ªá th·ªëng</p>
        </div>
        <a asp-action="Create" class="btn btn-gradient-primary btn-custom shadow">
            <i class="fas fa-pen-nib me-1"></i> T·∫°o h·ª£p ƒë·ªìng m·ªõi
        </a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible border-0 shadow-sm rounded-3 mb-3 fade show">
            <i class="fas fa-check-circle me-2"></i> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible border-0 shadow-sm rounded-3 mb-3 fade show">
            <i class="fas fa-exclamation-triangle me-2"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    {{-- Stat Cards --}}
    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="stat-card animate-fade-up" style="cursor:pointer" onclick="filterStatus('')">
                <div class="d-flex justify-content-between align-items-center">
                    <div><div class="stat-label">T·ªîNG H·ª¢P ƒê·ªíNG</div><div class="stat-value text-gradient mt-1">@total</div></div>
                    <div class="stat-icon-wrapper bg-icon-theme"><i class="fas fa-file-signature"></i></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card animate-fade-up" style="cursor:pointer;animation-delay:.1s" onclick="filterStatus('active')">
                <div class="d-flex justify-content-between align-items-center">
                    <div><div class="stat-label">ƒêANG HI·ªÜU L·ª∞C</div><div class="stat-value text-success mt-1">@active</div></div>
                    <div class="stat-icon-wrapper bg-icon-success"><i class="fas fa-check-circle"></i></div>
                </div>
                <small class="text-success fw-bold small">Click ƒë·ªÉ l·ªçc</small>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card animate-fade-up" style="cursor:pointer;animation-delay:.2s" onclick="filterStatus('terminated')">
                <div class="d-flex justify-content-between align-items-center">
                    <div><div class="stat-label">ƒê√É THANH L√ù</div><div class="stat-value mt-1" style="color:#e17055">@terminated</div></div>
                    <div class="stat-icon-wrapper bg-icon-warning"><i class="fas fa-file-contract"></i></div>
                </div>
                <small class="text-warning fw-bold small">Click ƒë·ªÉ l·ªçc</small>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card animate-fade-up" style="animation-delay:.3s">
                <div class="d-flex justify-content-between align-items-center">
                    <div><div class="stat-label">ƒê√É H·ª¶Y</div><div class="stat-value mt-1 text-danger">@cancelled</div></div>
                    <div class="stat-icon-wrapper bg-icon-info"><i class="fas fa-ban"></i></div>
                </div>
            </div>
        </div>
    </div>

    {{-- Filter Bar --}}
    <div class="main-card mb-3 p-4 animate-fade-up" style="animation-delay:.1s">
        <div class="row g-3 align-items-end">
            <div class="col-xl-4 col-md-6">
                <label class="fw-semibold small text-muted mb-1 d-block"><i class="fas fa-search me-1"></i>T√¨m ki·∫øm h·ª£p ƒë·ªìng</label>
                <div class="search-group">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchInput" placeholder="M√£ Hƒê, t√™n ph√≤ng, s·ªë ti·ªÅn c·ªçc..." oninput="applyFilters()">
                </div>
            </div>
            <div class="col-xl-2 col-md-4">
                <label class="fw-semibold small text-muted mb-1 d-block"><i class="fas fa-circle me-1"></i>Tr·∫°ng th√°i</label>
                <select class="form-select" id="filterStatus" onchange="applyFilters()">
                    <option value="">-- T·∫•t c·∫£ --</option>
                    <option value="active">ƒêang hi·ªáu l·ª±c</option>
                    <option value="terminated">ƒê√£ thanh l√Ω</option>
                    <option value="cancelled">ƒê√£ h·ªßy</option>
                </select>
            </div>
            <div class="col-xl-2 col-md-4">
                <label class="fw-semibold small text-muted mb-1 d-block"><i class="fas fa-calendar me-1"></i>T·ª´ ng√†y</label>
                <input type="date" class="form-control" id="filterDateFrom" onchange="applyFilters()">
            </div>
            <div class="col-xl-2 col-md-4">
                <label class="fw-semibold small text-muted mb-1 d-block"><i class="fas fa-calendar-check me-1"></i>ƒê·∫øn ng√†y</label>
                <input type="date" class="form-control" id="filterDateTo" onchange="applyFilters()">
            </div>
            <div class="col-xl-1 col-md-3">
                <label class="fw-semibold small text-muted mb-1 d-block">&nbsp;</label>
                <button class="btn btn-light border w-100" onclick="resetFilters()" title="X√≥a b·ªô l·ªçc">
                    <i class="fas fa-times text-muted"></i>
                </button>
            </div>
        </div>
        <div id="filterTags" class="mt-3 d-flex flex-wrap gap-2"></div>
    </div>

    {{-- Table --}}
    <div class="main-card animate-fade-up" style="animation-delay:.2s">
        <div class="card-header-styled">
            <div class="d-flex align-items-center gap-2">
                <i class="fas fa-file-signature text-brand"></i>
                <h5 class="fw-bold mb-0">Danh s√°ch h·ª£p ƒë·ªìng</h5>
                <span class="badge bg-soft-brand text-brand"><span id="visibleCount">@total</span> / @total</span>
            </div>
            <button class="btn btn-light border btn-sm" onclick="location.reload()"><i class="fas fa-sync-alt text-muted"></i></button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="dataTable">
                <thead class="table-light">
                    <tr>
                        <th style="cursor:pointer" onclick="sortTable(0)">M√£ Hƒê <i class="fas fa-sort ms-1 text-muted small"></i></th>
                        <th>Ph√≤ng</th>
                        <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                        <th>Ng√†y k·∫øt th√∫c</th>
                        <th class="text-end">Ti·ªÅn c·ªçc</th>
                        <th class="text-end">Gi√° thu√™</th>
                        <th class="text-center">Tr·∫°ng th√°i</th>
                        <th class="text-center" style="width:200px;">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            string sCls = (item.TrangThai == "Active" || item.TrangThai == "DangHieuLuc") ? "active"
                                        : (item.TrangThai == "Terminated" || item.TrangThai == "DaThanhLy") ? "terminated" : "cancelled";
                            string badge = sCls == "active" ? "bg-success" : sCls == "terminated" ? "bg-warning text-dark" : "bg-danger";
                            string label = sCls == "active" ? "ƒêang hi·ªáu l·ª±c" : sCls == "terminated" ? "ƒê√£ thanh l√Ω" : "ƒê√£ h·ªßy";
                            string dateStart = item.NgayBatDau.ToString("yyyy-MM-dd");
                            <tr data-status="@sCls" data-date="@dateStart">
                                <td>
                                    <div class="fw-bold"><i class="fas fa-file-contract text-muted me-1"></i>@item.ContractCode</div>
                                </td>
                                <td class="fw-bold text-success">@item.TenPhong</td>
                                <td><span class="badge bg-light border text-dark">@item.NgayBatDau.ToString("dd/MM/yyyy")</span></td>
                                <td>
                                    @if (item.NgayKetThuc.HasValue)
                                    {
                                        bool soonExpire = item.NgayKetThuc.Value <= DateTime.Now.AddDays(30);
                                        <span class="badge @(soonExpire ? "bg-warning text-dark" : "bg-light border text-dark")">
                                            @item.NgayKetThuc.Value.ToString("dd/MM/yyyy")
                                            @if (soonExpire) { <i class="fas fa-exclamation-triangle ms-1"></i> }
                                        </span>
                                    }
                                    else { <span class="text-muted small">V√¥ th·ªùi h·∫°n</span> }
                                </td>
                                <td class="text-end fw-bold text-warning">@item.TienCoc.ToString("N0") ƒë</td>
                                <td class="text-end fw-bold text-success">@item.GiaThue.ToString("N0") ƒë</td>
                                <td class="text-center"><span class="badge @badge rounded-pill px-3">@label</span></td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-1 flex-wrap">
                                        <a asp-action="Details" asp-route-id="@item.Id" class="action-btn btn btn-sm" style="background:#e3f2fd;color:#1565c0;" title="Chi ti·∫øt"><i class="fas fa-eye"></i></a>
                                        @if (sCls == "active")
                                        {
                                            <a asp-action="Extend" asp-route-id="@item.Id" class="action-btn btn btn-sm" style="background:#e8f5e9;color:#2e7d32;" title="Gia h·∫°n"><i class="fas fa-calendar-plus"></i></a>
                                            <a asp-action="Terminate" asp-route-id="@item.Id" class="action-btn btn btn-sm" style="background:#fff8e1;color:#f57f17;" title="Thanh l√Ω"><i class="fas fa-handshake"></i></a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <i class="fas fa-file-signature fa-3x text-muted opacity-25 d-block mb-3"></i>
                                <h6 class="text-muted">Ch∆∞a c√≥ h·ª£p ƒë·ªìng n√†o</h6>
                                <a asp-action="Create" class="btn btn-gradient-primary btn-sm mt-2"><i class="fas fa-plus me-1"></i> T·∫°o h·ª£p ƒë·ªìng</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div id="noResultsMsg" class="text-center py-4 d-none">
            <i class="fas fa-search fa-2x text-muted opacity-25 d-block mb-2"></i>
            <h6 class="text-muted">Kh√¥ng t√¨m th·∫•y h·ª£p ƒë·ªìng ph√π h·ª£p</h6>
            <button class="btn btn-sm btn-light border mt-1" onclick="resetFilters()"><i class="fas fa-times me-1"></i> X√≥a b·ªô l·ªçc</button>
        </div>

        <div class="d-flex justify-content-between align-items-center px-4 py-3 border-top bg-light rounded-bottom">
            <span class="text-muted small">Hi·ªÉn th·ªã <strong><span id="footerCount">@total</span></strong> / @total h·ª£p ƒë·ªìng</span>
            <span class="small">
                <span class="badge bg-success me-1">@active</span> Hƒê &nbsp;
                <span class="badge bg-warning text-dark me-1">@terminated</span> Thanh l√Ω &nbsp;
                <span class="badge bg-danger me-1">@cancelled</span> H·ªßy
            </span>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const allRows = Array.from(document.querySelectorAll('#dataTable tbody tr[data-status]'));
    let sortDir = {};

    function filterStatus(status) {
        document.getElementById('filterStatus').value = status;
        applyFilters();
    }

    function applyFilters() {
        const q       = document.getElementById('searchInput').value.toLowerCase().trim();
        const status  = document.getElementById('filterStatus').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo   = document.getElementById('filterDateTo').value;

        let visible = 0;
        allRows.forEach(row => {
            const matchQ  = !q || row.textContent.toLowerCase().includes(q);
            const matchSt = !status || row.dataset.status === status;
            const d       = row.dataset.date;
            const matchF  = !dateFrom || d >= dateFrom;
            const matchT  = !dateTo   || d <= dateTo;
            const show    = matchQ && matchSt && matchF && matchT;
            row.style.display = show ? '' : 'none';
            if (show) visible++;
        });

        ['visibleCount','footerCount'].forEach(id => document.getElementById(id).textContent = visible);
        document.getElementById('noResultsMsg').classList.toggle('d-none', visible > 0 || allRows.length === 0);
        renderTags(q, status, dateFrom, dateTo);
    }

    function renderTags(q, status, from, to) {
        const c = document.getElementById('filterTags');
        c.innerHTML = '';
        const tag = (label, clear) => c.innerHTML += `<span class="badge bg-soft-brand text-brand border px-3 py-2 rounded-pill" style="font-size:.8rem">${label} <span style="cursor:pointer;margin-left:6px" onclick="${clear}">‚úï</span></span>`;
        if (q) tag(`üîç "${q}"`, `document.getElementById('searchInput').value='';applyFilters()`);
        const sl = {active:'ƒêang hi·ªáu l·ª±c',terminated:'ƒê√£ thanh l√Ω',cancelled:'ƒê√£ h·ªßy'};
        if (status) tag(`üìÑ ${sl[status]}`, `document.getElementById('filterStatus').value='';applyFilters()`);
        if (from) tag(`üìÖ T·ª´: ${from}`, `document.getElementById('filterDateFrom').value='';applyFilters()`);
        if (to)   tag(`üìÖ ƒê·∫øn: ${to}`,  `document.getElementById('filterDateTo').value='';applyFilters()`);
    }

    function resetFilters() {
        ['searchInput','filterStatus','filterDateFrom','filterDateTo'].forEach(id => document.getElementById(id).value = '');
        applyFilters();
    }

    function sortTable(col) {
        const tbody = document.querySelector('#dataTable tbody');
        const rows  = Array.from(tbody.querySelectorAll('tr[data-status]'));
        const asc   = !sortDir[col];
        sortDir = {}; sortDir[col] = asc;
        rows.sort((a,b) => {
            const av = a.cells[col]?.textContent.trim() || '';
            const bv = b.cells[col]?.textContent.trim() || '';
            return asc ? av.localeCompare(bv,'vi') : bv.localeCompare(av,'vi');
        });
        rows.forEach(r => tbody.appendChild(r));
    }
</script>
}