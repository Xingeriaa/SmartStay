@model IEnumerable<do_an_tot_nghiep.ViewModels.KhachThueListItemViewModel>
@{
    ViewData["Title"] = "Quản lý cư dân";
    var total = Model?.Count() ?? 0;
    var active = Model?.Count(x => x.Status == "Active") ?? 0;
    var absent = Model?.Count(x => x.Status == "Temporary_Absent") ?? 0;
    var inactive = Model?.Count(x => x.Status != "Active" && x.Status != "Temporary_Absent") ?? 0;
}

<div class="container-fluid px-0 py-2">

    @* Header *@
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-4 gap-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Index" class="text-muted text-decoration-none"><i class="fas fa-home me-1"></i>Trang chủ</a></li>
                    <li class="breadcrumb-item active fw-medium">Cư dân</li>
                </ol>
            </nav>
            <h1 class="fw-bold mb-1" style="font-size:1.75rem; letter-spacing: -0.5px;">Quản lý cư dân</h1>
            <p class="text-secondary mb-0">Danh sách khách thuê trong toàn hệ thống</p>
        </div>
        <a asp-action="Create" class="btn btn-gradient-primary btn-custom shadow-sm rounded-pill px-4">
            <i class="fas fa-user-plus me-2"></i> Thêm cư dân mới
        </a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible border-0 shadow-sm rounded-3 mb-4 fade show d-flex align-items-center">
            <i class="fas fa-check-circle fs-5 me-3"></i>
            <div>@TempData["Success"]</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible border-0 shadow-sm rounded-3 mb-4 fade show d-flex align-items-center">
            <i class="fas fa-exclamation-triangle fs-5 me-3"></i>
            <div>@TempData["Error"]</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @* Stat Cards *@
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 stat-card animate-fade-up h-100 p-3" style="cursor:pointer" onclick="filterStatus('')">
                <div class="card-body p-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted fw-semibold small mb-1">TỔNG CƯ DÂN</div>
                            <h3 class="fw-bold text-dark mb-0">@total</h3>
                        </div>
                        <div class="stat-icon-wrapper bg-light rounded-circle p-3 text-secondary d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-users fs-5"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 stat-card animate-fade-up h-100 p-3" style="cursor:pointer;animation-delay:.1s" onclick="filterStatus('Active')">
                <div class="card-body p-1">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="text-muted fw-semibold small mb-1">ĐANG THUÊ</div>
                            <h3 class="fw-bold text-success mb-0">@active</h3>
                        </div>
                        <div class="stat-icon-wrapper bg-success bg-opacity-10 text-success rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-user-check fs-5"></i>
                        </div>
                    </div>
                    <small class="text-success fw-bold d-block mt-2" style="font-size:0.75rem;">(Lọc)</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 stat-card animate-fade-up h-100 p-3" style="cursor:pointer;animation-delay:.2s" onclick="filterStatus('Temporary_Absent')">
                <div class="card-body p-1">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="text-muted fw-semibold small mb-1">TẠM VẮNG</div>
                            <h3 class="fw-bold mb-0" style="color:#f39c12">@absent</h3>
                        </div>
                        <div class="stat-icon-wrapper bg-warning bg-opacity-10 text-warning rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-user-clock fs-5"></i>
                        </div>
                    </div>
                    <small class="text-warning fw-bold d-block mt-2" style="font-size:0.75rem;">(Lọc)</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 stat-card animate-fade-up h-100 p-3" style="animation-delay:.3s" onclick="filterStatus('Inactive')">
                <div class="card-body p-1">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="text-muted fw-semibold small mb-1">KHÔNG HOẠT ĐỘNG</div>
                            <h3 class="fw-bold text-danger mb-0">@inactive</h3>
                        </div>
                        <div class="stat-icon-wrapper bg-danger bg-opacity-10 text-danger rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-user-slash fs-5"></i>
                        </div>
                    </div>
                    <small class="text-danger fw-bold d-block mt-2" style="font-size:0.75rem;">(Lọc)</small>
                </div>
            </div>
        </div>
    </div>

    @* Filter Bar *@
    <div class="card border-0 shadow-sm rounded-4 mb-4 p-4 animate-fade-up" style="animation-delay:.1s">
        <div class="row g-3 align-items-end">
            <div class="col-xl-4 col-md-6">
                <label class="fw-semibold small text-secondary mb-2 d-block"><i class="fas fa-search me-1"></i>Tìm kiếm cư dân</label>
                <div class="input-group">
                    <span class="input-group-text bg-white text-muted border-end-0"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control border-start-0 shadow-none ps-0" id="searchInput" placeholder="Họ tên, CCCD, số điện thoại..." oninput="applyFilters()">
                </div>
            </div>
            <div class="col-xl-2 col-md-4">
                <label class="fw-semibold small text-secondary mb-2 d-block"><i class="fas fa-circle-notch me-1"></i>Trạng thái</label>
                <select class="form-select shadow-none" id="filterStatus" onchange="applyFilters()">
                    <option value="">-- Tất cả --</option>
                    <option value="Active">🟢 Đang thuê</option>
                    <option value="Temporary_Absent">🟡 Tạm vắng</option>
                    <option value="Inactive">🔴 Ngừng thuê</option>
                </select>
            </div>
            <div class="col-xl-3 col-md-4">
                <label class="fw-semibold small text-secondary mb-2 d-block"><i class="fas fa-birthday-cake me-1"></i>Năm sinh</label>
                <div class="d-flex gap-2">
                    <input type="number" class="form-control shadow-none" id="filterYearFrom" placeholder="Từ năm" min="1950" max="2010" oninput="applyFilters()">
                    <input type="number" class="form-control shadow-none" id="filterYearTo" placeholder="Đến năm" min="1950" max="2010" oninput="applyFilters()">
                </div>
            </div>
            <div class="col-xl-1">
                <label class="fw-semibold small text-secondary mb-2 d-block d-none d-md-block">&nbsp;</label>
                <button class="btn btn-light border w-100 shadow-sm" onclick="resetFilters()" title="Xóa bộ lọc"><i class="fas fa-sync-alt text-muted"></i></button>
            </div>
        </div>
        <div id="filterTags" class="mt-3 d-flex flex-wrap gap-2"></div>
    </div>

    @* Table *@
    <div class="card border-0 shadow-sm rounded-4 animate-fade-up overflow-hidden" style="animation-delay:.2s">
        <div class="card-header bg-white border-bottom p-4 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-3">
                    <i class="fas fa-users"></i>
                </div>
                <h5 class="fw-bold mb-0 ms-1">Danh sách cư dân</h5>
                <span class="badge bg-light text-dark border ms-2 rounded-pill"><span id="visibleCount">@total</span> / @total</span>
            </div>
            <button class="btn btn-light border shadow-sm btn-sm px-3 rounded-pill" onclick="location.reload()"><i class="fas fa-redo-alt text-secondary"></i></button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="dataTable">
                <thead class="table-light text-secondary text-uppercase small fw-bold" style="letter-spacing: 0.5px;">
                    <tr>
                        <th class="py-3">Họ tên</th>
                        <th class="py-3">CCCD</th>
                        <th class="py-3">Điện thoại</th>
                        <th class="text-center py-3">Ngày sinh</th>
                        <th class="text-center py-3">Trạng thái</th>
                        <th class="text-center py-3" style="width:130px;">Hành động</th>
                    </tr>
                </thead>
                <tbody class="border-top-0">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            string badge = item.Status == "Active" ? "bg-success text-success"
                            : item.Status == "Temporary_Absent" ? "bg-warning text-warning"
                            : "bg-danger text-danger";
                            string label = item.Status == "Active" ? "Đang thuê"
                            : item.Status == "Temporary_Absent" ? "Tạm vắng"
                            : item.Status ?? "—";
                            int birthYear = item.NgaySinh.Year;
                            <tr class="bg-white"
                                data-status="@item.Status"
                                data-name="@item.HoTen?.ToLower()"
                                data-cccd="@item.SoCCCD?.ToLower()"
                                data-phone="@item.SoDienThoai1?.ToLower()"
                                data-year="@birthYear">
                                <td>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width:48px;height:48px;flex-shrink:0;">
                                            <i class="fas fa-user text-secondary fs-5"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark fs-6">@item.HoTen</div>
                                            <small class="text-secondary">ID: #@item.Id</small>
                                        </div>
                                    </div>
                                </td>
                                <td><code class="text-muted small px-2 py-1 bg-light rounded border">@item.SoCCCD</code></td>
                                <td><span class="fw-medium text-dark">@item.SoDienThoai1</span></td>
                                <td class="text-center"><span class="badge bg-light border text-dark px-2 py-1">@item.NgaySinh.ToString("dd/MM/yyyy")</span></td>
                                <td class="text-center">
                                    <span class="badge @badge bg-opacity-10 border border-opacity-25 rounded-pill px-3 py-2">
                                        <i class="fas fa-circle me-1" style="font-size: 8px; vertical-align: middle;"></i> @label
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-light border text-primary rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 5px;" title="Chi tiết"><i class="fas fa-eye"></i></a>
                                        <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-light border text-warning rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 5px;" title="Sửa"><i class="fas fa-pen"></i></a>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                    <i class="fas fa-users fa-2x text-secondary opacity-50"></i>
                                </div>
                                <h6 class="text-dark fw-bold">Chưa có cư dân nào trong hệ thống</h6>
                                <p class="text-muted small mb-4">Hiện tại chưa có dữ liệu khách thuê nào được lưu.</p>
                                <a asp-action="Create" class="btn btn-primary shadow-sm rounded-pill px-4 mt-2"><i class="fas fa-user-plus me-2"></i> Thêm cư dân</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div id="noResultsMsg" class="text-center py-5 d-none bg-light">
            <i class="fas fa-user-slash fa-2x text-muted opacity-50 d-block mb-3"></i>
            <h6 class="text-dark fw-bold">Không tìm thấy cư dân phù hợp</h6>
            <p class="text-muted small">Hãy thử thay đổi điều kiện lọc hoặc từ khóa tìm kiếm</p>
            <button class="btn btn-outline-secondary btn-sm shadow-sm rounded-pill px-4 mt-2" onclick="resetFilters()"><i class="fas fa-times me-1"></i> Xóa tất cả bộ lọc</button>
        </div>

        <div class="px-4 py-4 border-top bg-light d-flex flex-wrap justify-content-between align-items-center">
            <span class="text-secondary small">Hiển thị <strong class="text-dark" id="footerCount">@total</strong> / @total cư dân</span>
            <div class="text-secondary small d-flex gap-3 mt-2 mt-md-0">
                <span><span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-2 me-1">@active</span> Đang thuê</span>
                <span><span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 rounded-pill px-2 me-1">@absent</span> Tạm vắng</span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const allRows = Array.from(document.querySelectorAll('#dataTable tbody tr[data-status]'));

        function filterStatus(st) {
            document.getElementById('filterStatus').value = st;
            applyFilters();
            document.getElementById('filterStatus').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function applyFilters() {
            const q       = document.getElementById('searchInput').value.toLowerCase().trim();
            const status  = document.getElementById('filterStatus').value;
            const yearFrom= parseInt(document.getElementById('filterYearFrom').value)||0;
            const yearTo  = parseInt(document.getElementById('filterYearTo').value)||9999;

            let visible = 0;
            allRows.forEach(row => {
                const matchQ  = !q || row.dataset.name?.includes(q) || row.dataset.cccd?.includes(q) || row.dataset.phone?.includes(q);
                const matchSt = !status || row.dataset.status === status;
                const yr = parseInt(row.dataset.year)||0;
                const matchY  = yr===0 || (yr>=yearFrom && yr<=yearTo);
                const show    = matchQ && matchSt && matchY;
                row.style.display = show ? '' : 'none';
                if (show) visible++;
            });
            ['visibleCount','footerCount'].forEach(id=> {
                if (document.getElementById(id)) {
                    document.getElementById(id).textContent=visible;
                }
            });
            document.getElementById('noResultsMsg').classList.toggle('d-none', visible>0||allRows.length===0);
            renderTags(q,status,yearFrom,yearTo);
        }

        function renderTags(q,status,yf,yt) {
            const c=document.getElementById('filterTags');
            if (!c) return;
            c.innerHTML='';
            const tag=(l,cl)=>c.innerHTML+=`<span class="badge bg-light text-secondary border px-3 py-2 rounded-pill shadow-sm d-inline-flex align-items-center" style="font-size:.8rem; font-weight: 500;">${l} <span class="ms-2 text-muted hover-danger" style="cursor:pointer;" onclick="${cl}"><i class="fas fa-times-circle"></i></span></span>`;
            if(q) tag(`🔍 Từ khóa: "${q}"`,`document.getElementById('searchInput').value='';applyFilters()`);

            const sLabel = { 'Active': '🟢 Đang thuê', 'Temporary_Absent': '🟡 Tạm vắng', 'Inactive': '🔴 Ngừng thuê' };
            if(status) tag(`${sLabel[status] || status}`,`document.getElementById('filterStatus').value='';applyFilters()`);
            if(yf>0) tag(`🎂 ${yf}-${yt===9999?'Nay':yt}`,`document.getElementById('filterYearFrom').value='';document.getElementById('filterYearTo').value='';applyFilters()`);
        }

        function resetFilters() {
            ['searchInput','filterStatus','filterYearFrom','filterYearTo'].forEach(id=>{
                if (document.getElementById(id)) {
                    document.getElementById(id).value='';
                }
            });
            applyFilters();
        }
    </script>
    <style>
        /* Add a small hover effect for rows */
        .table-hover tbody tr:hover {
            background-color: #f8f9fa !important;
            transition: background-color 0.2s ease;
        }
        /* Small hover effect on cancel/close buttons inside pills */
        .hover-danger:hover {
            color: #dc3545 !important;
        }
    </style>
}