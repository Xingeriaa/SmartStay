@model do_an_tot_nghiep.Models.PhongTro

@{
    ViewData["Title"] = "Chỉnh sửa chi tiết phòng | Quản lý hệ thống";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // --- LOGIC XỬ LÝ DỮ LIỆU ĐẦU VÀO ---
    var nhaInfo = ViewBag.ThongTinNha as do_an_tot_nghiep.Models.NhaTro;
    var danhSachDichVuToaNha = ViewBag.DichVuHienThi as List<do_an_tot_nghiep.Models.DichVu> ?? new List<do_an_tot_nghiep.Models.DichVu>();

    // Tách chuỗi dịch vụ hiện có từ Database để xử lý logic checkbox
    var currentServices = Model.DichVu?.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                                      .Select(s => s.Trim())
                                      .ToList() ?? new List<string>();
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    /* --- HỆ THỐNG BIẾN MÀU SẮC (THEME) --- */
    :root {
        --primary: var(--brand-600);
        --secondary: var(--accent-500);
        --accent: #ff9f43;
        --success: var(--brand-600);
        --danger: #ff6b6b;
        --dark: var(--ink-900);
        --light: var(--bg-body);
        --white: var(--bg-surface);
        --shadow-standard: 0 10px 30px rgba(0,0,0,0.08);
        --radius-lg: 20px;
        --font-family: 'Inter', 'Segoe UI', sans-serif;
    }

    /* --- LAYOUT CHÍNH --- */
    body {
        background-color: var(--bg-body);
        font-family: var(--font-family);
        color: var(--dark);
        scroll-behavior: smooth;
    }

    .edit-container {
        max-width: 1500px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    /* --- HEADER CHUYÊN NGHIỆP --- */
    .header-section {
        background: var(--white);
        padding: 30px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-standard);
        margin-bottom: 30px;
        border-left: 8px solid var(--accent);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-info h1 {
        font-weight: 800;
        font-size: 24px;
        margin: 0;
        color: var(--dark);
    }

    .header-info p {
        margin: 5px 0 0 0;
        color: #636e72;
    }

    /* --- CẤU TRÚC LƯỚI (GRID) --- */
    .main-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
    }

    /* --- STYLE CÁC THẺ CARD --- */
    .config-card {
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: 35px;
        box-shadow: var(--shadow-standard);
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.03);
    }

        .config-card .card-icon {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 80px;
            color: rgba(0, 184, 148, 0.08);
            z-index: 0;
        }

    .card-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--primary);
    }

        .card-title i {
            background: rgba(0, 184, 148, 0.12);
            padding: 10px;
            border-radius: 12px;
        }

    /* --- FORM CONTROLS NÂNG CAO --- */
    .form-floating > .form-control-custom {
        height: calc(3.5rem + 2px);
        line-height: 1.25;
    }

    .form-control-custom {
        width: 100%;
        padding: 14px 20px;
        border-radius: 12px;
        border: 2px solid #edf2f7;
        background: #fdfdfd;
        transition: all 0.3s;
        font-weight: 500;
    }

        .form-control-custom:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(78, 84, 200, 0.1);
            background: #fff;
            outline: none;
        }

    .label-custom {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        font-size: 14px;
        color: #4a5568;
    }

    /* --- SERVICE GRID SELECTOR --- */
    .service-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 15px;
    }

    .service-item {
        position: relative;
        cursor: pointer;
    }

        .service-item input {
            position: absolute;
            opacity: 0;
        }

    .service-box {
        padding: 20px;
        border: 2px solid #edf2f7;
        border-radius: 15px;
        text-align: center;
        transition: all 0.3s;
        background: #fff;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .service-item input:checked + .service-box {
        border-color: var(--primary);
        background: rgba(78, 84, 200, 0.02);
        box-shadow: 0 5px 15px rgba(78, 84, 200, 0.1);
    }

        .service-item input:checked + .service-box i {
            color: var(--primary);
            transform: scale(1.2);
        }

    .service-box i {
        font-size: 24px;
        margin-bottom: 10px;
        color: #cbd5e0;
        transition: 0.3s;
    }

    /* --- SIDEBAR PREVIEW (THE MOCKUP) --- */
    .sticky-sidebar {
        position: sticky;
        top: 20px;
    }

    .phone-mockup {
        background: #1e1e1e;
        border-radius: 40px;
        padding: 12px;
        box-shadow: 0 30px 60px rgba(0,0,0,0.2);
        border: 4px solid #333;
    }

    .inner-screen {
        background: #fff;
        border-radius: 30px;
        overflow: hidden;
        min-height: 600px;
    }

    .preview-banner {
        height: 220px;
        background: #dfe6e9;
        position: relative;
    }

        .preview-banner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .preview-content {
        padding: 20px;
    }

    .price-tag {
        color: var(--primary);
        font-size: 22px;
        font-weight: 800;
        margin-bottom: 15px;
    }

    .spec-grid {
        display: flex;
        justify-content: space-between;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 15px;
        margin-bottom: 20px;
    }

    .spec-item {
        text-align: center;
        font-size: 12px;
        color: #636e72;
    }

        .spec-item i {
            display: block;
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 5px;
        }

    /* --- BUTTONS --- */
    .btn-save {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 18px 40px;
        border-radius: 15px;
        font-weight: 700;
        border: none;
        box-shadow: 0 10px 20px rgba(78, 84, 200, 0.3);
        transition: 0.3s;
    }

        .btn-save:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(78, 84, 200, 0.4);
        }

    /* RESPONSIVE */
    @@media (max-width: 1100px) {
        .main-grid {
            grid-template-columns: 1fr;
        }

        .sticky-sidebar {
            position: static;
        }
    }
</style>

<div class="edit-container">

    <div class="header-section animate__animated animate__fadeInDown">
        <div class="header-info">
            <h1><i class="bi bi-pencil-square text-warning me-2"></i>Chỉnh Sửa Thông Tin Phòng</h1>
            <p><i class="bi bi-house-door me-1"></i> Tòa nhà: <strong>@nhaInfo?.TenNhaTro</strong> | Mã phòng: @Model.Id</p>
        </div>
        <div class="header-actions">
            <a asp-action="Index" asp-route-nhaId="@Model.NhaTroId" class="btn btn-outline-secondary rounded-pill px-4">
                <i class="bi bi-arrow-left me-2"></i>Quay lại danh sách
            </a>
        </div>
    </div>

    <form asp-action="Edit" method="post" enctype="multipart/form-data" id="mainEditForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="NhaTroId" />

        <div class="main-grid">

            <div class="left-content">

                <div class="config-card animate__animated animate__fadeInUp">
                    <i class="bi bi-info-circle card-icon"></i>
                    <div class="card-title">
                        <i class="bi bi-sliders"></i> Cấu hình thuộc tính phòng
                    </div>

                    <div class="row g-4">
                        <div class="col-md-7">
                            <label class="label-custom">Tên phòng / Số hiệu phòng</label>
                            <input asp-for="TenPhong" class="form-control-custom" id="txtTenPhong" placeholder="Ví dụ: Phòng 301..." oninput="syncPreview()" />
                            <span asp-validation-for="TenPhong" class="text-danger small"></span>
                        </div>
                        <div class="col-md-5">
                            <label class="label-custom">Vị trí tầng</label>
                            <select asp-for="Tang" class="form-control-custom" id="txtTang" onchange="syncPreview()">
                                @for (int i = 1; i <= 15; i++)
                                {
                                    <option value="@i">Tầng @i</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="label-custom">Diện tích sử dụng (m²)</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light"><i class="bi bi-aspect-ratio"></i></span>
                                <input asp-for="DienTich" type="number" step="0.1" class="form-control-custom" id="txtDienTich" oninput="syncPreview()" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="label-custom">Sức chứa (Người/phòng)</label>
                            <div class="input-group">
                                <span class="input-group-text border-0 bg-light"><i class="bi bi-people"></i></span>
                                <input asp-for="SoLuongNguoi" type="number" class="form-control-custom" id="txtNguoi" oninput="syncPreview()" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s">
                    <i class="bi bi-currency-dollar card-icon"></i>
                    <div class="card-title">
                        <i class="bi bi-cash-coin text-success"></i> Định mức giá & Đặt cọc
                    </div>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="label-custom">Giá thuê cố định (VNĐ/tháng)</label>
                            <input asp-for="GiaPhong" type="number" class="form-control-custom text-primary" id="txtGia" style="font-size: 20px; font-weight: 800;" oninput="syncPreview()" />
                        </div>
                        <div class="col-md-6">
                            <label class="label-custom">Tiền đặt cọc (VNĐ)</label>
                            <input asp-for="TienCoc" type="number" class="form-control-custom" id="txtCoc" oninput="syncPreview()" />
                        </div>
                    </div>
                </div>

                <div class="config-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s">
                    <div class="card-title">
                        <i class="bi bi-box-seam text-info"></i> Dịch vụ áp dụng & Nội thất
                    </div>

                    <div class="mb-4">
                        <label class="label-custom mb-3">Phân loại nội thất:</label>
                        <div class="d-flex gap-3">
                            @foreach (var type in new[] { "Phòng trống", "Cơ bản", "Full nội thất" })
                            {
                                <div class="flex-fill">
                                    <input type="radio" class="btn-check" asp-for="NoiThat" value="@type" id="nt_@type" onchange="syncPreview()">
                                    <label class="btn btn-outline-primary w-100 py-3 rounded-4" for="nt_@type">@type</label>
                                </div>
                            }
                        </div>
                    </div>

                    <label class="label-custom mb-3">Tùy chọn dịch vụ tại tòa nhà:</label>
                    <div class="service-grid">
                        @foreach (var item in danhSachDichVuToaNha)
                        {
                            <label class="service-item">
                                <input type="checkbox" name="selectedDichVu" value="@item.Ten"
                                       @(currentServices.Contains(item.Ten) ? "checked" : "")
                                       onchange="syncPreview()">
                                <div class="service-box">
                                    @{
                                        string icon = "bi-check-circle";
                                        if (item.Ten.ToLower().Contains("điện")) icon = "bi-lightning-charge";
                                        else if (item.Ten.ToLower().Contains("nước")) icon = "bi-droplet";
                                        else if (item.Ten.ToLower().Contains("wifi")) icon = "bi-wifi";
                                        else if (item.Ten.ToLower().Contains("xe")) icon = "bi-bicycle";
                                    }
                                    <i class="bi @icon"></i>
                                    <div class="fw-bold small">@item.Ten</div>
                                    <div class="text-muted small">@item.DonGia.ToString("N0")đ</div>
                                </div>
                            </label>
                        }
                    </div>
                </div>

                <div class="config-card animate__animated animate__fadeInUp" style="animation-delay: 0.3s">
                    <div class="card-title">
                        <i class="bi bi-camera text-danger"></i> Quản lý truyền thông (Media)
                    </div>

                    <div class="row align-items-center mb-4">
                        <div class="col-md-4">
                            <div class="rounded-4 overflow-hidden shadow-sm border">
                                <img src="@(Model.AnhPhong ?? "/images/no-image.jpg")" id="imgOld" class="w-100" style="height: 150px; object-fit: cover;">
                                <div class="bg-light p-2 text-center small fw-bold">ẢNH HIỆN TẠI</div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <label class="label-custom">Tải lên ảnh mới (Thay thế)</label>
                            <input asp-for="ImageFile" type="file" class="form-control-custom" id="fileInput" accept="image/*" onchange="previewImage(this)" />
                            <p class="text-muted small mt-2"><i class="bi bi-info-circle me-1"></i> Định dạng hỗ trợ: JPG, PNG, WEBP. Dung lượng < 5MB.</p>
                        </div>
                    </div>

                    <label class="label-custom">Mô tả chi tiết / Ghi chú</label>
                    <textarea asp-for="GhiChu" class="form-control-custom" rows="4" id="txtGhiChu" placeholder="Ví dụ: Phòng có ban công, hướng Đông Nam..." oninput="syncPreview()"></textarea>
                </div>

                <div class="p-4 bg-white rounded-4 shadow-sm d-flex justify-content-between align-items-center mb-5 border">
                    <div class="text-muted small">
                        <i class="bi bi-clock-history me-1"></i> Cập nhật lần cuối: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
                    </div>
                    <button type="submit" class="btn-save animate__animated animate__pulse animate__infinite">
                        <i class="bi bi-check-all me-2"></i>XÁC NHẬN CẬP NHẬT
                    </button>
                </div>
            </div>

            <div class="right-sidebar">
                <div class="sticky-sidebar animate__animated animate__fadeInRight">
                    <h6 class="fw-bold mb-3 text-center text-muted">BẢN XEM TRƯỚC TRÊN DI ĐỘNG</h6>
                    <div class="phone-mockup">
                        <div class="inner-screen">
                            <div class="preview-banner">
                                <img id="p-img" src="@Model.AnhPhong" onerror="this.src='https://via.placeholder.com/400x300?text=Room+Image'">
                                <div class="position-absolute top-0 end-0 m-3 badge bg-danger rounded-pill shadow">Đang trống</div>
                            </div>
                            <div class="preview-content">
                                <div id="p-name" class="h5 fw-bold mb-1">@Model.TenPhong</div>
                                <div class="small text-muted mb-3"><i class="bi bi-geo-alt me-1"></i>@nhaInfo?.TenNhaTro</div>

                                <div id="p-price" class="price-tag">@Model.GiaPhong.ToString("N0") <span class="small fw-normal text-muted" style="font-size: 14px">đ/tháng</span></div>

                                <div class="spec-grid">
                                    <div class="spec-item">
                                        <i class="bi bi-aspect-ratio"></i>
                                        <span id="p-area">@Model.DienTich</span> m²
                                    </div>
                                    <div class="spec-item">
                                        <i class="bi bi-people"></i>
                                        <span id="p-nguoi">@Model.SoLuongNguoi</span> người
                                    </div>
                                    <div class="spec-item">
                                        <i class="bi bi-layers"></i>
                                        <span id="p-tang">Tầng @Model.Tang</span>
                                    </div>
                                </div>

                                <div class="fw-bold small mb-2">Tiện ích đi kèm:</div>
                                <div id="p-services" class="d-flex flex-wrap gap-1 mb-4">
                                    @foreach (var s in currentServices)
                                    {
                                        <span class="badge bg-light text-primary border border-primary-subtle">@s</span>
                                    }
                                </div>

                                <div class="alert alert-warning py-2 rounded-3">
                                    <div class="fw-bold" style="font-size: 11px;">THÔNG TIN CỌC:</div>
                                    <div id="p-coc" style="font-size: 13px;">@Model.TienCoc.ToString("N0") VNĐ</div>
                                </div>

                                <div id="p-desc" class="small text-muted fst-italic border-top pt-3">
                                    @Model.GhiChu
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // --- HÀM ĐỒNG BỘ DỮ LIỆU SANG PREVIEW (REAL-TIME) ---
        function syncPreview() {
            // Lấy dữ liệu từ các input
            const name = document.getElementById('txtTenPhong').value || "Tên phòng";
            const price = document.getElementById('txtGia').value || 0;
            const area = document.getElementById('txtDienTich').value || 0;
            const cap = document.getElementById('txtNguoi').value || 0;
            const floor = document.getElementById('txtTang').value;
            const coc = document.getElementById('txtCoc').value || 0;
            const desc = document.getElementById('txtGhiChu').value;

            // Định dạng tiền tệ
            const fmtPrice = new Intl.NumberFormat('vi-VN').format(price);
            const fmtCoc = new Intl.NumberFormat('vi-VN').format(coc);

            // Đổ vào Preview
            document.getElementById('p-name').innerText = name;
            document.getElementById('p-price').innerHTML = `${fmtPrice} <span class="small fw-normal text-muted" style="font-size: 14px">đ/tháng</span>`;
            document.getElementById('p-area').innerText = area;
            document.getElementById('p-nguoi').innerText = cap;
            document.getElementById('p-tang').innerText = "Tầng " + floor;
            document.getElementById('p-coc').innerText = fmtCoc + " VNĐ";
            document.getElementById('p-desc').innerText = desc || "Chưa có mô tả chi tiết...";

            // Cập nhật dịch vụ
            const serviceContainer = document.getElementById('p-services');
            serviceContainer.innerHTML = '';

            // Lấy nội thất (Radio)
            const activeNT = document.querySelector('input[name="NoiThat"]:checked');
            if(activeNT) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary text-white';
                badge.innerText = activeNT.value;
                serviceContainer.appendChild(badge);
            }

            // Lấy Checkbox dịch vụ
            document.querySelectorAll('input[name="selectedDichVu"]:checked').forEach(item => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-light text-primary border border-primary-subtle';
                badge.innerText = item.value;
                serviceContainer.appendChild(badge);
            });
        }

        // --- HÀM PREVIEW ẢNH KHI CHỌN FILE ---
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('p-img').src = e.target.result;
                    document.getElementById('p-img').classList.add('animate__animated', 'animate__fadeIn');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- XỬ LÝ SUBMIT CHUYÊN NGHIỆP ---
        document.getElementById('mainEditForm').onsubmit = function(e) {
            e.preventDefault();

            Swal.fire({
                title: 'Xác nhận thay đổi?',
                text: "Dữ liệu phòng sẽ được cập nhật ngay lập tức vào hệ thống!",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#00b894',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Đồng ý, Lưu ngay!',
                cancelButtonText: 'Xem lại'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Đang lưu...',
                        didOpen: () => { Swal.showLoading() }
                    });
                    this.submit();
                }
            });
        };

        // Khởi tạo chạy preview lần đầu khi load trang
        window.onload = syncPreview;
    </script>
}