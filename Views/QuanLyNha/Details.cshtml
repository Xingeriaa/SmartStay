@model do_an_tot_nghiep.Models.NhaTro
@using do_an_tot_nghiep.Models
@{
    ViewData["Title"] = "Chi tiết nhà trọ | " + Model?.TenNhaTro;
    var listDichVu = ViewBag.ListDichVu as List<DichVu>;
    var dsPhong    = ViewBag.DanhSachPhong as List<PhongTro>;
    var selectedIds = Model?.DanhSachDichVu?.Split(',').Select(s => s.Trim()).ToList() ?? new();
}

<div class="container-fluid px-0">
    {{-- Breadcrumb + Header --}}
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Index" class="text-muted text-decoration-none"><i class="fas fa-home me-1"></i>Trang chủ</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index" class="text-muted text-decoration-none">Nhà trọ</a></li>
                    <li class="breadcrumb-item active">Chi tiết</li>
                </ol>
            </nav>
            <h1 class="fw-bold mb-0" style="font-size:1.75rem;">@Model?.TenNhaTro</h1>
            <p class="text-muted mb-0 mt-1"><i class="fas fa-map-marker-alt me-1"></i>@Model?.DiaChiChiTiet — @Model?.PhuongXa, @Model?.QuanHuyen, @Model?.TinhThanh</p>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="Edit" asp-route-id="@Model?.Id" class="btn btn-gradient-primary btn-custom">
                <i class="fas fa-edit me-1"></i> Chỉnh sửa
            </a>
            <a asp-controller="QuanLyPhong" asp-action="Index" asp-route-nhaId="@Model?.Id" class="btn btn-light border btn-custom">
                <i class="fas fa-door-open me-1"></i> Xem phòng
            </a>
            <a asp-action="Index" class="btn btn-light border btn-custom">
                <i class="fas fa-arrow-left me-1"></i> Quay lại
            </a>
        </div>
    </div>

    <div class="row g-4">
        {{-- Left column - Basic Info --}}
        <div class="col-xl-4 col-lg-5">
            {{-- Building Card --}}
            <div class="main-card mb-4 animate-fade-up">
                <div style="height:180px;background:var(--brand-gradient);border-radius:16px 16px 0 0;display:flex;align-items:center;justify-content:center;position:relative;">
                    <i class="fas fa-building fa-4x text-white opacity-75"></i>
                    <div style="position:absolute;top:12px;right:12px;">
                        <span class="badge bg-white text-brand px-3 py-2 fw-bold">
                            <i class="fas fa-check-circle me-1"></i>Đang hoạt động
                        </span>
                    </div>
                </div>
                <div class="p-4">
                    <h4 class="fw-bold mb-1">@Model?.TenNhaTro</h4>
                    <p class="text-muted small mb-3"><i class="fas fa-map-marker-alt me-1 text-brand"></i>@Model?.DiaChiChiTiet</p>

                    <hr class="my-3">

                    <div class="row g-3 text-center">
                        <div class="col-4">
                            <div class="fw-bold text-gradient" style="font-size:1.5rem;">@(dsPhong?.Count ?? 0)</div>
                            <div class="text-muted small">Tổng phòng</div>
                        </div>
                        <div class="col-4">
                            <div class="fw-bold text-success" style="font-size:1.5rem;">@(dsPhong?.Count(p => p.Status == "Vacant") ?? 0)</div>
                            <div class="text-muted small">Còn trống</div>
                        </div>
                        <div class="col-4">
                            <div class="fw-bold" style="font-size:1.5rem;color:#0984e3">@(dsPhong?.Count(p => p.Status == "Occupied") ?? 0)</div>
                            <div class="text-muted small">Đang thuê</div>
                        </div>
                    </div>
                </div>
            </div>

            {{-- Info Card --}}
            <div class="main-card animate-fade-up" style="animation-delay:.1s">
                <div class="card-header-styled">
                    <h6 class="fw-bold mb-0"><i class="fas fa-info-circle me-2 text-brand"></i>Thông tin chi tiết</h6>
                </div>
                <div class="p-4">
                    <table class="table table-borderless table-sm mb-0">
                        <tbody>
                            <tr>
                                <td class="text-muted fw-medium" style="width:140px;">Mã tòa nhà</td>
                                <td class="fw-bold">#@Model?.Id</td>
                            </tr>
                            <tr>
                                <td class="text-muted fw-medium">Số tầng</td>
                                <td><span class="badge bg-light border text-dark">@(Model?.LoaiNha == 0 ? "Trệt" : Model?.LoaiNha + " tầng")</span></td>
                            </tr>
                            <tr>
                                <td class="text-muted fw-medium">Giá thuê TB</td>
                                <td class="fw-bold text-success">@Model?.GiaThue.ToString("N0") đ</td>
                            </tr>
                            <tr>
                                <td class="text-muted fw-medium">Ngày thu tiền</td>
                                <td><span class="badge bg-light border text-dark">Ngày @Model?.NgayThuTien hàng tháng</span></td>
                            </tr>
                            <tr>
                                <td class="text-muted fw-medium">Địa chỉ đầy đủ</td>
                                <td class="small">@Model?.DiaChiChiTiet, @Model?.PhuongXa, @Model?.QuanHuyen, @Model?.TinhThanh</td>
                            </tr>
                            <tr>
                                <td class="text-muted fw-medium">Ngày tạo</td>
                                <td class="small text-muted">@Model?.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                            </tr>
                        </tbody>
                    </table>

                    @if (listDichVu != null && selectedIds.Any())
                    {
                        <hr>
                        <div class="mb-1 fw-medium text-muted small">Dịch vụ tích hợp:</div>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var dv in listDichVu.Where(d => selectedIds.Contains(d.Id.ToString())))
                            {
                                <span class="badge badge-soft-brand">
                                    <i class="fas fa-check me-1"></i>@dv.Ten
                                </span>
                            }
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model?.GhiChu))
                    {
                        <hr>
                        <div class="mb-1 fw-medium text-muted small">Ghi chú / Nội quy:</div>
                        <p class="small text-dark mb-0">@Model.GhiChu</p>
                    }
                </div>
            </div>
        </div>

        {{-- Right column - Room list --}}
        <div class="col-xl-8 col-lg-7">
            <div class="main-card animate-fade-up" style="animation-delay:.15s">
                <div class="card-header-styled">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-door-open text-brand"></i>
                        <h6 class="fw-bold mb-0">Danh sách phòng trong nhà</h6>
                        <span class="badge bg-soft-brand text-brand">@(dsPhong?.Count ?? 0) phòng</span>
                    </div>
                    <a asp-controller="QuanLyPhong" asp-action="Create" asp-route-nhaId="@Model?.Id" class="btn btn-gradient-primary btn-sm">
                        <i class="fas fa-plus me-1"></i> Thêm phòng
                    </a>
                </div>

                @if (dsPhong != null && dsPhong.Any())
                {
                    @* mini search *@
                    <div class="px-4 pt-3">
                        <div class="search-group" style="max-width:320px;">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="roomSearch" placeholder="Tìm tên phòng, tầng...">
                        </div>
                    </div>
                    <div class="table-responsive mt-2">
                        <table class="table table-hover align-middle mb-0" id="roomTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Phòng</th>
                                    <th class="text-center">Tầng</th>
                                    <th class="text-center">DT</th>
                                    <th class="text-end">Giá thuê</th>
                                    <th class="text-center">Trạng thái</th>
                                    <th class="text-center">Sức chứa</th>
                                    <th class="text-center" style="width:120px;">Hành động</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var p in dsPhong)
                                {
                                    string sCls = p.Status switch { "Vacant" => "bg-success", "Occupied" => "bg-primary", "Maintenance" => "bg-warning text-dark", _ => "bg-secondary" };
                                    string sLbl = p.Status switch { "Vacant" => "Trống", "Occupied" => "Đang thuê", "Maintenance" => "Bảo trì", _ => p.Status };
                                    <tr>
                                        <td>
                                            <div class="fw-bold">@p.TenPhong</div>
                                            <small class="text-muted">ID: @p.Id</small>
                                        </td>
                                        <td class="text-center"><span class="badge bg-light border text-dark">T@p.Tang</span></td>
                                        <td class="text-center"><span class="text-muted small">@p.DienTich m²</span></td>
                                        <td class="text-end fw-bold text-gradient">@p.GiaPhong.ToString("N0") đ</td>
                                        <td class="text-center"><span class="badge @sCls rounded-pill">@sLbl</span></td>
                                        <td class="text-center"><span class="text-muted small">@p.SoLuongNguoi người</span></td>
                                        <td class="text-center">
                                            <div class="d-flex justify-content-center gap-1">
                                                <a asp-controller="QuanLyPhong" asp-action="Details" asp-route-id="@p.Id"
                                                   class="action-btn btn btn-sm" style="background:#e3f2fd;color:#1565c0;" title="Xem chi tiết">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a asp-controller="QuanLyPhong" asp-action="Edit" asp-route-id="@p.Id"
                                                   class="action-btn btn btn-sm" style="background:#fff8e1;color:#f57f17;" title="Sửa">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-door-open fa-3x text-muted opacity-25 mb-3 d-block"></i>
                        <h6 class="text-muted">Chưa có phòng nào trong tòa nhà này</h6>
                        <a asp-controller="QuanLyPhong" asp-action="Create" asp-route-nhaId="@Model?.Id" class="btn btn-gradient-primary btn-sm mt-2">
                            <i class="fas fa-plus me-1"></i> Thêm phòng đầu tiên
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.getElementById('roomSearch')?.addEventListener('input', function () {
        const q = this.value.toUpperCase();
        document.querySelectorAll('#roomTable tbody tr').forEach(r => {
            r.style.display = r.textContent.toUpperCase().includes(q) ? '' : 'none';
        });
    });
</script>
}
