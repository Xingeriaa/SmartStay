@model do_an_tot_nghiep.Models.NhaTro
@using do_an_tot_nghiep.Models
@{
    ViewData["Title"] = "Chi tiết nhà trọ | " + Model?.TenNhaTro;
    var listDichVu = ViewBag.ListDichVu as List<DichVu>;
    var dsPhong = ViewBag.DanhSachPhong as List<PhongTro>;
    var selectedIds = Model?.DanhSachDichVu?.Split(',').Select(s => s.Trim()).ToList() ?? new();
}

<div class="container-fluid px-0 py-2">
    @* Breadcrumb + Header *@
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-4 gap-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Index" class="text-muted text-decoration-none"><i class="fas fa-home me-1"></i>Trang chủ</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index" class="text-muted text-decoration-none">Nhà trọ</a></li>
                    <li class="breadcrumb-item active fw-medium">Chi tiết</li>
                </ol>
            </nav>
            <h1 class="fw-bold mb-1" style="font-size:1.75rem; letter-spacing: -0.5px;">@Model?.TenNhaTro</h1>
            <p class="text-secondary mb-0"><i class="fas fa-map-marker-alt me-2 text-danger opacity-75"></i>@Model?.DiaChiChiTiet — @Model?.PhuongXa, @Model?.QuanHuyen, @Model?.TinhThanh</p>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="Index" class="btn btn-light border btn-custom shadow-sm rounded-pill px-3">
                <i class="fas fa-arrow-left me-1"></i> Quay lại
            </a>
            <a asp-controller="QuanLyPhong" asp-action="Index" asp-route-nhaId="@Model?.Id" class="btn btn-light border text-primary btn-custom shadow-sm rounded-pill px-3">
                <i class="fas fa-door-open me-1"></i> Xem phòng
            </a>
            <a asp-action="Edit" asp-route-id="@Model?.Id" class="btn btn-gradient-primary btn-custom shadow-sm rounded-pill px-4">
                <i class="fas fa-pen me-1"></i> Chỉnh sửa
            </a>
        </div>
    </div>

    <div class="row g-4">
        @* Left column - Basic Info *@
        <div class="col-xl-4 col-lg-5">
            @* Building Card *@
            <div class="card border-0 shadow-sm rounded-4 mb-4 animate-fade-up overflow-hidden">
                <div style="height:160px;background: linear-gradient(135deg, var(--bs-primary) 0%, #4facfe 100%);display:flex;align-items:center;justify-content:center;position:relative;">
                    <i class="fas fa-building fa-4x text-white opacity-50"></i>
                    <div style="position:absolute;top:16px;right:16px;">
                        <span class="badge bg-white text-success px-3 py-2 fw-bold shadow-sm rounded-pill">
                            <i class="fas fa-check-circle me-1"></i>Đang hoạt động
                        </span>
                    </div>
                </div>
                <div class="card-body p-4">
                    <h4 class="fw-bold mb-1 text-dark">@Model?.TenNhaTro</h4>
                    <p class="text-secondary small mb-3"><i class="fas fa-map-marker-alt me-1 text-primary opacity-75"></i>@Model?.DiaChiChiTiet</p>

                    <hr class="my-4 text-muted opacity-25">

                    <div class="row g-3 text-center">
                        <div class="col-4 border-end">
                            <div class="fw-bold text-dark" style="font-size:1.5rem;">@(dsPhong?.Count ?? 0)</div>
                            <div class="text-secondary small fw-medium">Tổng phòng</div>
                        </div>
                        <div class="col-4 border-end">
                            <div class="fw-bold text-success" style="font-size:1.5rem;">@(dsPhong?.Count(p => p.Status == "Vacant") ?? 0)</div>
                            <div class="text-secondary small fw-medium">Còn trống</div>
                        </div>
                        <div class="col-4">
                            <div class="fw-bold text-primary" style="font-size:1.5rem;">@(dsPhong?.Count(p => p.Status == "Occupied") ?? 0)</div>
                            <div class="text-secondary small fw-medium">Đang thuê</div>
                        </div>
                    </div>
                </div>
            </div>

            @* Info Card *@
            <div class="card border-0 shadow-sm rounded-4 animate-fade-up" style="animation-delay:.1s">
                <div class="card-header bg-white border-bottom p-4">
                    <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-info-circle me-2 text-primary opacity-75"></i>Thông tin chi tiết</h6>
                </div>
                <div class="card-body p-4">
                    <table class="table table-borderless table-sm mb-0">
                        <tbody>
                            <tr>
                                <td class="text-secondary fw-medium align-middle" style="width:140px; padding-bottom: 12px;">Mã tòa nhà</td>
                                <td class="fw-bold text-dark" style="padding-bottom: 12px;">#@Model?.Id</td>
                            </tr>
                            <tr>
                                <td class="text-secondary fw-medium align-middle" style="padding-bottom: 12px;">Số tầng</td>
                                <td style="padding-bottom: 12px;"><span class="badge bg-light border text-dark px-2 py-1">@(Model?.LoaiNha == 0 ? "Trệt" : Model?.LoaiNha + " tầng")</span></td>
                            </tr>
                            <tr>
                                <td class="text-secondary fw-medium align-middle" style="padding-bottom: 12px;">Giá thuê TB</td>
                                <td class="fw-bold text-success" style="padding-bottom: 12px; font-size: 1.05rem;">@Model?.GiaThue.ToString("N0") <small class="fw-normal">đ</small></td>
                            </tr>
                            <tr>
                                <td class="text-secondary fw-medium align-middle" style="padding-bottom: 12px;">Ngày thu tiền</td>
                                <td style="padding-bottom: 12px;"><span class="badge bg-light border text-dark px-2 py-1"><i class="fas fa-calendar-alt text-muted me-1"></i>Ngày @Model?.NgayThuTien hàng tháng</span></td>
                            </tr>
                            <tr>
                                <td class="text-secondary fw-medium align-top" style="padding-bottom: 12px;">Địa chỉ đầy đủ</td>
                                <td class="small text-dark" style="padding-bottom: 12px; line-height: 1.5;">@Model?.DiaChiChiTiet, @Model?.PhuongXa, @Model?.QuanHuyen, @Model?.TinhThanh</td>
                            </tr>
                            <tr>
                                <td class="text-secondary fw-medium align-middle">Ngày tạo</td>
                                <td class="small text-muted">@Model?.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                            </tr>
                        </tbody>
                    </table>

                    @if (listDichVu != null && selectedIds.Any())
                    {
                        <hr class="my-4 text-muted opacity-25">
                        <div class="mb-2 fw-semibold text-dark small">Dịch vụ tích hợp:</div>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var dv in listDichVu.Where(d => selectedIds.Contains(d.Id.ToString())))
                            {
                                <span class="badge bg-light text-secondary border fw-normal px-2 py-1 shadow-sm">
                                    <i class="fas fa-check text-success me-1 opacity-75"></i>@dv.Ten
                                </span>
                            }
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model?.GhiChu))
                    {
                        <hr class="my-4 text-muted opacity-25">
                        <div class="mb-2 fw-semibold text-dark small">Ghi chú / Nội quy:</div>
                        <div class="p-3 bg-light rounded-3 text-secondary small" style="line-height: 1.6;">
                            @Model.GhiChu
                        </div>
                    }
                </div>
            </div>
        </div>

        @* Right column - Room list *@
        <div class="col-xl-8 col-lg-7">
            <div class="card border-0 shadow-sm rounded-4 animate-fade-up overflow-hidden h-100" style="animation-delay:.15s">
                <div class="card-header bg-white border-bottom p-4 d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-3">
                            <i class="fas fa-door-open"></i>
                        </div>
                        <h5 class="fw-bold mb-0 ms-1">Danh sách phòng trong nhà</h5>
                        <span class="badge bg-light text-dark border ms-2 rounded-pill">@(dsPhong?.Count ?? 0) phòng</span>
                    </div>
                    <a asp-controller="QuanLyPhong" asp-action="Create" asp-route-nhaId="@Model?.Id" class="btn btn-primary btn-sm shadow-sm rounded-pill px-3">
                        <i class="fas fa-plus me-1"></i> Thêm phòng
                    </a>
                </div>

                @if (dsPhong != null && dsPhong.Any())
                {
                    @* mini search *@
                    <div class="px-4 pt-4 pb-2">
                        <div class="input-group shadow-sm rounded-3" style="max-width:320px;">
                            <span class="input-group-text bg-white text-muted border-end-0"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control border-start-0 shadow-none ps-0" id="roomSearch" placeholder="Tìm tên phòng, tầng...">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="roomTable">
                            <thead class="table-light text-secondary text-uppercase small fw-bold" style="letter-spacing: 0.5px;">
                                <tr>
                                    <th class="py-3 px-4">Phòng</th>
                                    <th class="text-center py-3">Tầng</th>
                                    <th class="text-center py-3">DT</th>
                                    <th class="text-end py-3">Giá thuê</th>
                                    <th class="text-center py-3">Trạng thái</th>
                                    <th class="text-center py-3">Sức chứa</th>
                                    <th class="text-center py-3" style="width:120px;">Hành động</th>
                                </tr>
                            </thead>
                            <tbody class="border-top-0">
                                @foreach (var p in dsPhong)
                                {
                                    string sCls = p.Status switch { "Vacant" => "bg-success text-success", "Occupied" => "bg-primary text-primary", "Maintenance" => "bg-warning text-warning", _ => "bg-secondary text-secondary" };
                                    string sLbl = p.Status switch { "Vacant" => "Trống", "Occupied" => "Đang thuê", "Maintenance" => "Bảo trì", _ => p.Status };
                                    <tr class="bg-white">
                                        <td class="px-4">
                                            <div class="d-flex align-items-center gap-3">
                                                <div class="bg-light rounded-3 d-flex align-items-center justify-content-center border" style="width: 40px; height: 40px;">
                                                    <i class="fas fa-bed text-secondary opacity-50"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold text-dark fs-6">@p.TenPhong</div>
                                                    <small class="text-secondary">ID: #@p.Id</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center"><span class="badge bg-light border text-dark px-2 py-1">Tầng @p.Tang</span></td>
                                        <td class="text-center"><span class="text-secondary fw-medium">@p.DienTich m²</span></td>
                                        <td class="text-end">
                                            <span class="fw-bold text-dark d-block">@p.GiaPhong.ToString("N0") <small class="text-secondary fw-normal">đ</small></span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge @sCls bg-opacity-10 border border-opacity-25 rounded-pill px-3 py-2">
                                                <i class="fas fa-circle me-1" style="font-size: 8px; vertical-align: middle;"></i> @sLbl
                                            </span>
                                        </td>
                                        <td class="text-center"><span class="text-secondary fw-medium">@p.SoLuongNguoi ng</span></td>
                                        <td class="text-center">
                                            <div class="d-flex justify-content-center gap-2">
                                                <a asp-controller="QuanLyPhong" asp-action="Details" asp-route-id="@p.Id"
                                                   class="btn btn-sm btn-light border text-primary rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 5px;" title="Xem chi tiết">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a asp-controller="QuanLyPhong" asp-action="Edit" asp-route-id="@p.Id"
                                                   class="btn btn-sm btn-light border text-warning rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 5px;" title="Sửa">
                                                    <i class="fas fa-pen"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                            <i class="fas fa-door-open fa-2x text-secondary opacity-50"></i>
                        </div>
                        <h6 class="text-dark fw-bold">Chưa có phòng nào trong tòa nhà này</h6>
                        <p class="text-muted small mb-4">Hãy bắt đầu tạo những căn phòng đầu tiên cho tòa nhà.</p>
                        <a asp-controller="QuanLyPhong" asp-action="Create" asp-route-nhaId="@Model?.Id" class="btn btn-primary shadow-sm rounded-pill px-4">
                            <i class="fas fa-plus me-2"></i> Thêm phòng đầu tiên
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('roomSearch')?.addEventListener('input', function () {
            const q = this.value.toUpperCase();
            document.querySelectorAll('#roomTable tbody tr').forEach(r => {
                // Tối ưu để không tìm kiếm vào các icon hay thành phần ẩn
                const textContent = r.textContent || r.innerText;
                r.style.display = textContent.toUpperCase().includes(q) ? '' : 'none';
            });
        });
    </script>
    <style>
        .table-hover tbody tr:hover {
            background-color: #f8f9fa !important;
            transition: background-color 0.2s ease;
        }
    </style>
}