@model do_an_tot_nghiep.Models.NhaTro
@using do_an_tot_nghiep.Models
@{
    ViewData["Title"] = "Chỉnh sửa nhà trọ";
    var listDichVu = ViewBag.ListDichVu as List<DichVu>;
    var selectedIds = Model?.DanhSachDichVu?.Split(',').Select(s => s.Trim()).ToList() ?? new();
}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>

<div class="container-fluid px-0 py-2">
    @* Header *@
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-4 gap-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Index" class="text-muted text-decoration-none"><i class="fas fa-home me-1"></i>Trang chủ</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index" class="text-muted text-decoration-none">Nhà trọ</a></li>
                    <li class="breadcrumb-item active fw-medium">Chỉnh sửa</li>
                </ol>
            </nav>
            <h1 class="fw-bold mb-1" style="font-size:1.75rem; letter-spacing: -0.5px;">Chỉnh sửa: @Model?.TenNhaTro</h1>
            <p class="text-secondary mb-0">Cập nhật thông tin tòa nhà <span class="badge bg-light text-dark border">#@Model?.Id</span></p>
        </div>
        <a asp-action="Index" class="btn btn-light border btn-custom shadow-sm rounded-pill px-4">
            <i class="fas fa-arrow-left me-2"></i> Quay lại
        </a>
    </div>

    <form asp-action="Edit" asp-route-id="@Model?.Id" method="post" id="editForm">
        @Html.AntiForgeryToken()
        <input asp-for="Id" type="hidden">

        <div class="row g-4">
            @* Left: Basic + Address *@
            <div class="col-xl-8">

                @* Basic Info *@
                <div class="card border-0 shadow-sm rounded-4 mb-4 animate-fade-up">
                    <div class="card-header bg-white border-bottom p-4">
                        <div class="d-flex align-items-center gap-3">
                            <div class="bg-primary bg-opacity-10 p-2 rounded-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="fas fa-home text-primary fs-5"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-0 text-dark">Thông tin cơ bản</h6>
                                <small class="text-muted">Tên gọi, giá cả và đặc điểm chính</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-12">
                                <label class="fw-semibold mb-2 text-dark">Tên nhà trọ <span class="text-danger">*</span></label>
                                <input asp-for="TenNhaTro" class="form-control shadow-none" placeholder="Ví dụ: Chung cư mini Quận 7" required>
                                <span asp-validation-for="TenNhaTro" class="text-danger small mt-1 d-block"></span>
                            </div>
                            <div class="col-md-5">
                                <label class="fw-semibold mb-2 text-dark">Giá thuê (VNĐ/tháng)</label>
                                <div class="input-group">
                                    <input asp-for="GiaThue" type="number" class="form-control shadow-none" id="inputPrice" min="0">
                                    <span class="input-group-text bg-light text-secondary fw-medium">đ</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="fw-semibold mb-2 text-dark">Số tầng</label>
                                <select asp-for="LoaiNha" class="form-select shadow-none" id="inputFloor">
                                    <option value="0">Trệt (1 tầng)</option>
                                    <option value="2">2 tầng</option>
                                    <option value="3">3 tầng</option>
                                    <option value="4">4 tầng</option>
                                    <option value="5">5 tầng trở lên</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="fw-semibold mb-2 text-dark">Ngày thu tiền</label>
                                <select asp-for="NgayThuTien" class="form-select shadow-none">
                                    @for (int i = 1; i <= 28; i++)
                                    {
                                        <option value="@i">Ngày @i</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                @* Address *@
                <div class="card border-0 shadow-sm rounded-4 mb-4 animate-fade-up" style="animation-delay:.1s">
                    <div class="card-header bg-white border-bottom p-4">
                        <div class="d-flex align-items-center gap-3">
                            <div class="bg-primary bg-opacity-10 p-2 rounded-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="fas fa-map-marker-alt text-primary fs-5"></i>
                            </div>
                            <h6 class="fw-bold mb-0 text-dark">Địa chỉ</h6>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <label class="fw-semibold mb-2 text-dark">Tỉnh / Thành phố</label>
                                <select id="city" asp-for="TinhThanh" class="form-select shadow-none">
                                    <option value="">Chọn Tỉnh/Thành</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="fw-semibold mb-2 text-dark">Quận / Huyện</label>
                                <select id="district" asp-for="QuanHuyen" class="form-select shadow-none">
                                    <option value="">Chọn Quận/Huyện</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="fw-semibold mb-2 text-dark">Phường / Xã</label>
                                <select id="ward" asp-for="PhuongXa" class="form-select shadow-none">
                                    <option value="">Chọn Phường/Xã</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="fw-semibold mb-2 text-dark">Số nhà, Tên đường <span class="text-danger">*</span></label>
                                <input asp-for="DiaChiChiTiet" class="form-control shadow-none" placeholder="Ví dụ: 123 Nguyễn Thị Minh Khai" required>
                                <span asp-validation-for="DiaChiChiTiet" class="text-danger small mt-1 d-block"></span>
                            </div>
                        </div>
                    </div>
                </div>

                @* Services *@
                <div class="card border-0 shadow-sm rounded-4 mb-4 animate-fade-up" style="animation-delay:.2s">
                    <div class="card-header bg-white border-bottom p-4">
                        <div class="d-flex align-items-center gap-3">
                            <div class="bg-primary bg-opacity-10 p-2 rounded-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="fas fa-concierge-bell text-primary fs-5"></i>
                            </div>
                            <h6 class="fw-bold mb-0 text-dark">Tiện ích & Dịch vụ</h6>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        @if (listDichVu != null && listDichVu.Any())
                        {
                            <div class="row g-3">
                                @foreach (var dv in listDichVu)
                                {
                                    bool isChecked = selectedIds.Contains(dv.Id.ToString());
                                    <div class="col-md-3 col-6">
                                        <label class="d-flex align-items-center gap-2 p-3 border rounded-3 service-check @(isChecked ? "border-primary bg-primary bg-opacity-10" : "bg-light")"
                                               style="cursor:pointer; transition:all .2s ease;" for="dv_@dv.Id">
                                            <input type="checkbox" name="DichVuSelect" value="@dv.Id"
                                                   id="dv_@dv.Id" class="form-check-input shadow-none mt-0" @(isChecked ? "checked" : "")>
                                            <span class="fw-medium text-dark small">@dv.Ten</span>
                                            <small class="text-secondary ms-auto">@dv.DonGia.ToString("N0")đ</small>
                                        </label>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="p-3 bg-light rounded-3 text-center border">
                                <p class="text-muted small mb-0">Chưa có dịch vụ nào được thiết lập trong hệ thống.</p>
                            </div>
                        }

                        <div class="mt-4 pt-3 border-top">
                            <label class="fw-semibold mb-2 text-dark">Ghi chú / Nội quy</label>
                            <textarea asp-for="GhiChu" class="form-control shadow-none" rows="4" placeholder="Nhập ghi chú, nội quy riêng của nhà trọ..."></textarea>
                        </div>
                    </div>
                </div>

                @* Submit *@
                <div class="d-flex gap-3 mb-4 animate-fade-up" style="animation-delay:.3s">
                    <a asp-action="Index" class="btn btn-light border shadow-sm rounded-pill px-4 py-2">
                        <i class="fas fa-times me-2"></i> Hủy bỏ
                    </a>
                    <button type="submit" class="btn btn-primary shadow-sm rounded-pill flex-grow-1 py-2 fw-medium">
                        <i class="fas fa-save me-2"></i> Lưu cập nhật nhà trọ
                    </button>
                </div>
            </div>

            @* Right: Summary panel *@
            <div class="col-xl-4">
                <div class="card border-0 shadow-sm rounded-4 animate-fade-up" style="animation-delay:.1s; position:sticky; top:80px;">
                    <div class="card-header bg-white border-bottom p-4">
                        <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-eye me-2 text-primary opacity-75"></i>Xem trước</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="text-center py-4 rounded-4 mb-4 shadow-sm" style="background: linear-gradient(135deg, var(--bs-primary) 0%, #4facfe 100%);">
                            <i class="fas fa-building fa-3x text-white mb-3 d-block opacity-50"></i>
                            <h5 class="text-white fw-bold mb-0 px-3" id="prvName">@Model?.TenNhaTro</h5>
                        </div>
                        <ul class="list-group list-group-flush small mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3 border-bottom-dashed">
                                <span class="text-secondary"><i class="fas fa-tag me-2 opacity-50"></i>Giá thuê</span>
                                <span class="fw-bold text-success fs-6" id="prvPrice">@Model?.GiaThue.ToString("N0") đ</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3 border-bottom-dashed">
                                <span class="text-secondary"><i class="fas fa-layer-group me-2 opacity-50"></i>Số tầng</span>
                                <span class="fw-bold text-dark" id="prvFloor">@(Model?.LoaiNha == 0 ? "Trệt" : Model?.LoaiNha + " tầng")</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3">
                                <span class="text-secondary"><i class="fas fa-calendar-alt me-2 opacity-50"></i>Ngày thu tiền</span>
                                <span class="fw-bold text-dark">Ngày @Model?.NgayThuTien</span>
                            </li>
                        </ul>
                        <a asp-action="Details" asp-route-id="@Model?.Id" class="btn btn-light border w-100 shadow-sm rounded-pill py-2 text-primary fw-medium">
                            <i class="fas fa-external-link-alt me-2"></i> Xem trang chi tiết
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        // Live preview
        document.querySelector('[name="TenNhaTro"]')?.addEventListener('input', e => {
            document.getElementById('prvName').textContent = e.target.value || 'Tên nhà trọ';
        });
        document.querySelector('[name="GiaThue"]')?.addEventListener('input', e => {
            const n = parseInt(e.target.value) || 0;
            document.getElementById('prvPrice').textContent = n.toLocaleString('vi-VN') + ' đ';
        });
        document.querySelector('[name="LoaiNha"]')?.addEventListener('change', e => {
            const v = parseInt(e.target.value);
            document.getElementById('prvFloor').textContent = v === 0 ? 'Trệt' : v + ' tầng';
        });

        // Checkbox service highlight
        document.querySelectorAll('.service-check input').forEach(cb => {
            cb.addEventListener('change', function () {
                const parent = this.closest('.service-check');
                parent.classList.toggle('border-primary', this.checked);
                parent.classList.toggle('bg-primary', this.checked);
                parent.classList.toggle('bg-opacity-10', this.checked);
                parent.classList.toggle('bg-light', !this.checked);
            });
        });

        // Load province API and pre-select saved values
        const savedCity = "@Model?.TinhThanh";
        const savedDistrict = "@Model?.QuanHuyen";
        const savedWard = "@Model?.PhuongXa";
        const cityEl = document.getElementById('city');
        const distEl = document.getElementById('district');
        const wardEl = document.getElementById('ward');

        axios.get('https://provinces.open-api.vn/api/?depth=1').then(res => {
            res.data.forEach(item => {
                const opt = new Option(item.name, item.name);
                opt.dataset.code = item.code;
                if (item.name === savedCity) opt.selected = true;
                cityEl.add(opt);
            });
            if (savedCity) triggerLoadDistrict();
        });

        function triggerLoadDistrict() {
            const sel = cityEl.options[cityEl.selectedIndex];
            if (!sel?.dataset?.code) return;
            axios.get(`https://provinces.open-api.vn/api/p/${sel.dataset.code}?depth=2`).then(res => {
                distEl.length = 1;
                res.data.districts.forEach(d => {
                    const opt = new Option(d.name, d.name);
                    opt.dataset.code = d.code;
                    if (d.name === savedDistrict) opt.selected = true;
                    distEl.add(opt);
                });
                if (savedDistrict) triggerLoadWard();
            });
        }

        function triggerLoadWard() {
            const sel = distEl.options[distEl.selectedIndex];
            if (!sel?.dataset?.code) return;
            axios.get(`https://provinces.open-api.vn/api/d/${sel.dataset.code}?depth=2`).then(res => {
                wardEl.length = 1;
                res.data.wards.forEach(w => {
                    const opt = new Option(w.name, w.name);
                    if (w.name === savedWard) opt.selected = true;
                    wardEl.add(opt);
                });
            });
        }

        cityEl.addEventListener('change', () => { distEl.length = 1; wardEl.length = 1; triggerLoadDistrict(); });
        distEl.addEventListener('change', () => { wardEl.length = 1; triggerLoadWard(); });
    </script>
    <style>
        .border-bottom-dashed {
            border-bottom: 1px dashed #dee2e6 !important;
        }
    </style>
}